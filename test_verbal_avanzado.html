<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test de Razonamiento Verbal (Avanzado) – Supervisores Asturiano</title>
  <style>
    :root{--brand-red:#E41D23;--brand-blue:#003C8F;--ink:#111827;--muted:#6b7280;--bg:#f4f6f9;--card:#ffffff;--line:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .hero{background:linear-gradient(120deg, rgba(0,60,143,.92), rgba(228,29,35,.92)), url('https://images.unsplash.com/photo-1520975916090-3105956dac38');background-size:cover;background-position:center;padding:56px 20px;color:#fff;text-align:center}
    .hero h1{font-size:clamp(24px,4vw,40px);margin:0 0 8px}
    .hero p{margin:0;opacity:.95}
    .container{max-width:1120px;margin:-40px auto 40px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,.08);padding:18px}
    .form-row{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .form-row input{flex:1;min-width:220px;padding:10px;border:1px solid var(--line);border-radius:10px}
    .question{margin-bottom:12px;padding:12px;border-radius:10px;border:1px solid var(--line)}
    .qtitle{font-weight:700;color:var(--brand-blue);margin-bottom:8px}
    .options label{display:block;padding:8px 10px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .15s;border:1px dashed transparent}
    .options input{margin-right:10px}
    .options label:hover{background:#f7fbff}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--brand-red);color:#fff}
    .btn-ghost{background:transparent;border:1px solid var(--line)}
    .btn-danger{background:#991b1b;color:#fff}
    .small{font-size:13px;color:var(--muted)}
    .badge{background:var(--brand-blue);color:#fff;padding:6px 8px;border-radius:999px;font-weight:700}
    .list-sub{max-height:300px;overflow:auto;border:1px solid var(--line);border-radius:8px;padding:8px}
    .entry{padding:8px;border-radius:8px;border-bottom:1px solid var(--line);display:flex;gap:8px;justify-content:space-between;align-items:center}
    .entry:last-child{border-bottom:0}
    .muted{color:var(--muted)}
    .selected{background:#eef3ff;border-color:#a7c0ff}
    .analysis-summary{margin-bottom:16px;padding:12px;border-radius:10px;background:#f9fafb;border:1px solid var(--line)}
    .analysis-summary h3{margin:0 0 8px;color:var(--brand-blue)}
    .analysis-summary p{margin:4px 0}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);margin-right:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="hero">
    <h1>Test de Razonamiento Verbal (Avanzado)</h1>
    <p>Supervisores de UDN — Tiendas Asturiano. Envío cifrado; resultados solo visibles con PIN autorizado.</p>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Test -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="small">Completa los datos y responde. No se muestran resultados tras el envío.</div>
          <div class="badge">A+ ASTURIANO</div>
        </div>
        <div class="form-row">
          <input id="participantName" placeholder="Nombre del evaluado (ej. Juan Pérez)" />
          <input id="participantUDN" placeholder="UDN (ej. UDN-045)" />
        </div>
        <form id="quizForm">
          <div id="quizArea"></div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap">
            <button class="btn btn-primary" type="submit">Enviar respuestas (no muestra resultado)</button>
            <button class="btn btn-ghost" type="button" id="clearForm">Limpiar</button>
            <div class="small">Tus envíos quedan cifrados en este navegador.</div>
          </div>
        </form>
        <div id="msg" class="small" style="margin-top:8px"></div>
      </div>

      <!-- Admin panel -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap">
            <strong>Ver resultados (acceso restringido)</strong>
            <span class="small">PIN requerido</span>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
            <input id="pinInput" placeholder="PIN" />
            <button id="unlockBtn" class="btn btn-primary">Abrir</button>
            <button id="clearAll" class="btn btn-danger">Borrar todo</button>
            <button id="exportAll" class="btn btn-ghost">Exportar JSON</button>
            <button id="exportExcel" class="btn btn-ghost">Descargar Excel</button>
            <button id="refreshList" class="btn btn-ghost">Actualizar</button>
          </div>
          <div id="unlockMsg" class="small muted"></div>
          <div id="resultBox" style="display:none;margin-top:12px">
            <div id="submissionsList" class="list-sub"></div>
            <div style="height:12px"></div>
            <div id="analysisArea"></div>
          </div>
          <div class="small" style="margin-top:10px">Nota: si tu navegador bloquea el guardado, ábrelo con un servidor local (p. ej. <code>python -m http.server</code> y entra a <code>http://localhost:8000</code>).</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  window.onload = () => {
    const questions=[
      {q:"En un reporte de corte Z aparece: “Venta total $12,340; retiro $3,000; efectivo final $9,340”. ¿Cuál es el error de redacción en términos de coherencia?",opts:["No se especifica hora del retiro.","La suma no corresponde a la operación.","Falta el nombre del cajero.","El total debería expresarse con IVA."],correct:1},
      {q:"Instrucción más precisa para un cíclico con faltantes de alto valor:",opts:["Se revisó inventario y falta mercancía.","Se detectó diferencia de 15 botellas de tequila; se justifica con recepción pendiente.","Parece que faltan botellas caras.","Se realizará ajuste en sistema sin nota."],correct:1},
      {q:"¿Cuál frase tiene mejor coherencia temporal para un correo a dirección?",opts:["Se envió el reporte de hoy mañana a las 9:00.","El reporte del día 15 se entregará hoy antes de las 11:00.","Ayer se entregará el reporte semanal.","El corte Z de mañana ya se mandó."],correct:1},
      {q:"Si en un correo se escribe: “El empresario refiere que ya cuadró la caja aunque no envió evidencia”, ¿qué aspecto debe corregirse para un reporte formal?",opts:["Evitar “refiere” y usar “informó”.","Señalar explícitamente la ausencia de evidencia.","No usar la palabra empresario.","Cambiar “ya cuadró” por “cuadrará”."],correct:1},
      {q:"Opción con mejor formalidad y precisión para solicitar ajuste de inventario:",opts:["Te encargo que revises lo del inventario.","Favor de revisar cíclico de categoría lácteos; diferencia de 24 piezas registrada en sistema.","Revisa lo que falta en refrigerador.","Me avisas si te da tiempo de ajustar."],correct:1},
      {q:"¿Cuál presenta incoherencia en un reporte?",opts:["Se rechazó mercancía por fecha de caducidad expirada.","Se levantó incidencia de proveedor por faltantes en entrega.","Se aplicó promoción el 3x2 después de la fecha de vigencia.","Se actualizó el sistema con evidencias de recepción."],correct:2},
      {q:"Uso correcto de conectores lógicos:",opts:["Se cuadró la caja, además, se detectaron diferencias.","Se realizó el corte Z; sin embargo, persisten diferencias de $250.","Se aplicó la promoción, porque se revisó el inventario.","El proveedor entregó, asimismo, el sistema no registró la entrada."],correct:1},
      {q:"Instrucción adecuada para un correo de seguimiento a un cajero:",opts:["Oye, checa bien la caja.","Se solicita verificación del arqueo Z y envío de comprobante fotográfico antes de las 21:00.","Revisa tu corte.","No olvides lo del Z."],correct:1},
      {q:"Si en un cíclico hay faltantes recurrentes en la misma categoría, ¿qué debe incluir la redacción del reporte?",opts:["Explicar que es común y no pasa nada.","Señalar recurrencia y proponer acción correctiva.","Solo registrar la diferencia.","Omitir detalle para no repetir información."],correct:1},
      {q:"Redacción más clara para un informe a gerencia:",opts:["El empresario no mandó nada.","El empresario omitió enviar corte Z del 12/09; se solicitó reenvío inmediato.","No hubo reporte.","Falta documento."],correct:1},
      {q:"¿Cuál muestra uso incorrecto del tiempo verbal?",opts:["Hoy se revisará el cíclico de perecederos.","Ayer se aplicó la promoción en refrescos.","Mañana se realizó la entrega de abarrotes.","Se registró la merma de la semana pasada."],correct:2},
      {q:"Mejor estructura formal:",opts:["Favor de enviar arqueo Z del día 10 antes de las 12:00 hrs. con evidencia fotográfica.","Mándame el corte del 10 si puedes.","El corte de ayer falta.","Pues si pueden me lo mandan."],correct:0},
      {q:"Frase más objetiva en un reporte de supervisión:",opts:["Parece que el cajero no cuadró bien.","El corte Z presenta diferencia de $125, sin evidencia de retiro.","El cajero estuvo distraído.","Hay errores frecuentes en la caja."],correct:1},
      {q:"Completa: “En caso de detectar diferencias en corte Z, el supervisor debe ___.”",opts:["Aplicar sanción automática.","Registrar incidencia y solicitar evidencia al empresario.","Hacer caso omiso.","Ajustar manualmente el sistema."],correct:1},
      {q:"¿Cuál es menos adecuada en un contexto de reporte formal?",opts:["Se levantó incidencia de proveedor por falta de evidencias.","El empresario informó de la diferencia de 15 piezas en recepción.","Se cuadró el corte Z con $300 de diferencia justificada.","Pues parece que todo está bien."],correct:3}
    ];

    // Render preguntas
    const quizArea=document.getElementById('quizArea');
    questions.forEach((it,idx)=>{
      const div=document.createElement('div'); div.className='question';
      const qtitle=document.createElement('div'); qtitle.className='qtitle'; qtitle.textContent=`${idx+1}. ${it.q}`;
      div.appendChild(qtitle);
      const opts=document.createElement('div'); opts.className='options';
      it.opts.forEach((o,i)=>{
        const lbl=document.createElement('label');
        lbl.innerHTML=`<input type='radio' name='q${idx}' value='${i}'> ${o}`;
        lbl.addEventListener('click',()=>{
          [...opts.querySelectorAll('label')].forEach(l=>l.classList.remove('selected'));
          lbl.classList.add('selected');
        });
        opts.appendChild(lbl);
      });
      div.appendChild(opts); quizArea.appendChild(div);
    });

    // Storage + PIN
    const STORAGE_KEY='asturiano_verbal_adv_enc';
    const DEFAULT_PIN='6483';
    const encodeRecord=(obj,pin)=> btoa(pin+'|'+JSON.stringify(obj));
    const decodeRecord=(enc,pin)=>{ try{const dec=atob(enc); if(!dec.startsWith(pin+'|')) return null; return JSON.parse(dec.slice(pin.length+1));}catch(e){return null} };
    const saveSubmission=(enc)=>{ const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); arr.push(enc); localStorage.setItem(STORAGE_KEY,JSON.stringify(arr)); };
    const getAllSubmissions=()=> JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    const deleteSubmission=(index)=>{ const arr=getAllSubmissions(); arr.splice(index,1); localStorage.setItem(STORAGE_KEY,JSON.stringify(arr)); };

    document.getElementById('quizForm').addEventListener('submit',e=>{
      e.preventDefault();
      const name=document.getElementById('participantName').value.trim();
      const udn=document.getElementById('participantUDN').value.trim();
      if(!name||!udn){document.getElementById('msg').textContent='Completa nombre y UDN.'; return}
      const answers=[]; for(let i=0;i<questions.length;i++){ const sel=document.querySelector(`input[name=q${i}]:checked`); answers.push(sel?parseInt(sel.value):null); }
      if(answers.some(v=>v===null)){document.getElementById('msg').textContent='Responde todas las preguntas.'; return}
      const record={name,udn,timestamp:new Date().toISOString(),answers};
      saveSubmission(encodeRecord(record,DEFAULT_PIN));
      document.getElementById('quizForm').reset();
      document.getElementById('msg').textContent='Respuestas guardadas. Usa el PIN en el panel derecho para ver resultados.';
    });

    document.getElementById('clearForm').addEventListener('click',()=>{document.getElementById('quizForm').reset();document.getElementById('msg').textContent='Formulario limpio.'});

    // Admin
    document.getElementById('unlockBtn').addEventListener('click',()=>{
      const pin=document.getElementById('pinInput').value.trim();
      const arr=getAllSubmissions();
      if(arr.length===0){document.getElementById('unlockMsg').textContent='No hay registros.'; return}
      const ok=arr.some(enc=>decodeRecord(enc,pin));
      if(!ok){document.getElementById('unlockMsg').textContent='PIN incorrecto.'; return}
      document.getElementById('unlockMsg').textContent='PIN correcto.';
      document.getElementById('resultBox').style.display='block';
      populateList(pin);
    });

    document.getElementById('refreshList').addEventListener('click',()=>{
      const pin=document.getElementById('pinInput').value.trim();
      populateList(pin);
    });

    document.getElementById('exportAll').addEventListener('click',()=>{
      const pin=document.getElementById('pinInput').value.trim();
      const arr=getAllSubmissions().map(enc=>decodeRecord(enc,pin)).filter(Boolean);
      const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`resultados_verbal_avanzado_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
    });

    document.getElementById('exportExcel').addEventListener('click',()=>{
      const pin=document.getElementById('pinInput').value.trim();
      const raw=getAllSubmissions().map(enc=>decodeRecord(enc,pin)).filter(Boolean);
      if(!raw.length){ alert('No hay registros para exportar.'); return; }
      const rows = raw.map((r,idx)=>{
        const base={ "#": idx+1, "Nombre": r.name, "UDN": r.udn, "Fecha/Hora": new Date(r.timestamp).toLocaleString() };
        r.answers.forEach((a,i)=>{ base[`P${i+1}`]=a; });
        const correctCount = r.answers.filter((a,i)=>a===questions[i].correct).length;
        base["Aciertos"]=correctCount; base["Errores"]=r.answers.length - correctCount;
        return base;
      });
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Resultados");
      XLSX.writeFile(wb, "resultados_test_verbal_avanzado.xlsx");
    });

    document.getElementById('clearAll').addEventListener('click',()=>{
      const pin=document.getElementById('pinInput').value.trim();
      if(!pin){alert('Ingresa el PIN'); return}
      if(!confirm('¿Seguro que deseas borrar TODOS los registros?')) return;
      const arr=getAllSubmissions();
      if(arr.length && !decodeRecord(arr[0],pin)){ alert('PIN incorrecto'); return;}
      localStorage.setItem(STORAGE_KEY,JSON.stringify([]));
      populateList(pin);
      document.getElementById('analysisArea').innerHTML='';
      alert('Registros eliminados.');
    });

    function populateList(pin){
      const container=document.getElementById('submissionsList'); container.innerHTML='';
      const arr=getAllSubmissions();
      arr.forEach((enc,idx)=>{
        const rec=decodeRecord(enc,pin); if(!rec) return;
        const div=document.createElement('div'); div.className='entry';
        div.innerHTML=`<div><strong>${rec.name}</strong>
           <div class='muted'>${rec.udn} • ${new Date(rec.timestamp).toLocaleString()}</div></div>
           <div>
             <button class='btn btn-ghost' data-idx='${idx}' data-action='view'>Ver</button>
             <button class='btn btn-danger' data-idx='${idx}' data-action='del'>Borrar</button>
           </div>`;
        container.appendChild(div);
      });
      container.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click',e=>{
        const idx=parseInt(e.currentTarget.getAttribute('data-idx'));
        const action=e.currentTarget.getAttribute('data-action');
        const pin=document.getElementById('pinInput').value.trim();
        if(action==='view'){ showAnalysis(idx,pin); }
        if(action==='del'){ if(confirm('¿Borrar este registro?')){ deleteSubmission(idx); populateList(pin); } }
      }));
    }

    function showAnalysis(index,pin){
      const rec=decodeRecord(getAllSubmissions()[index],pin); if(!rec) return;
      const total=questions.length;
      const correct=rec.answers.filter((a,i)=>a===questions[i].correct).length;
      const incorrect=total-correct;

      const bueno=[]; const malo=[];
      if(correct/total>=0.85){bueno.push("Dominio alto de redacción formal aplicada a UDN y reportes operativos.");}
      else if(correct/total>=0.65){bueno.push("Base sólida en coherencia, conectores y solicitudes formales.");}
      else {malo.push("Debe reforzar coherencia temporal, precisión en instrucciones y objetividad en reportes.");}

      const focusMap = {
        2: "Coherencia temporal y claridad de compromisos (fechas/horas).",
        6: "Uso adecuado de conectores lógicos (sin embargo, por tanto, etc.).",
        7: "Solicitudes operativas formales y medibles (plazo y evidencia).",
        9: "Comunicación ejecutiva: petición concreta con contexto y acción.",
        10:"Manejo correcto de tiempos verbales.",
        12:"Estructura formal en solicitudes (formato y cortes).",
        13:"Objetividad basada en evidencia (evitar juicios subjetivos).",
        14:"Protocolo ante diferencias en corte Z (incidencia + evidencia)."
      };
      Object.keys(focusMap).forEach(k=>{
        const i=parseInt(k); if(rec.answers[i]!==questions[i].correct){ malo.push(focusMap[i]); }
      });

      const recomendado=[
        "Plantillas de correos y reportes con campos obligatorios (fecha, evidencia, acción).",
        "Checklist de coherencia temporal y uso de conectores por tipo de reporte.",
        "Microtaller: objetividad vs. juicio (evidencia y métricas)."
      ];

      const area=document.getElementById('analysisArea'); area.innerHTML='';
      const summary=document.createElement('div'); summary.className='analysis-summary';
      summary.innerHTML = `<h3>Resumen</h3>
        <p class='pill'>Aciertos: ${correct}/${total}</p>
        <p class='pill'>Errores: ${incorrect}/${total}</p>
        <p><strong>Lo bueno:</strong> ${bueno.join(' ')||'—'}</p>
        <p><strong>Lo malo:</strong> ${malo.join(' ')||'—'}</p>
        <p><strong>Recomendado:</strong> ${recomendado.join(' • ')}</p>`;
      area.appendChild(summary);

      const canvas=document.createElement('canvas'); area.appendChild(canvas);
      new Chart(canvas,{
        type:'bar',
        data:{labels:['Aciertos','Errores'],datasets:[{label:'Resultados',data:[correct,incorrect]}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
      });
    }
  }
  </script>
</body>
</html>
